<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Diagnostics and Spike-and-Slab Summaries • bgms</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Diagnostics and Spike-and-Slab Summaries">
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bgms</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.6.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/comparison.html">Model Comparison with bgmCompare</a></li>
    <li><a class="dropdown-item" href="../articles/diagnostics.html">Diagnostics and Spike-and-Slab Summaries</a></li>
    <li><a class="dropdown-item" href="../articles/intro.html">Getting Started with bgms</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Bayesian-Graphical-Modelling-Lab/bgms/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Diagnostics and Spike-and-Slab Summaries</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Bayesian-Graphical-Modelling-Lab/bgms/blob/main/vignettes/diagnostics.Rmd" class="external-link"><code>vignettes/diagnostics.Rmd</code></a></small>
      <div class="d-none name"><code>diagnostics.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette illustrates how to inspect convergence diagnostics and
how to interpret spike-and-slab summaries in <strong>bgms</strong>
models. For some of the model variables spike-and-slab priors introduce
binary indicator variables that govern whether the effect is included or
not. Their posterior distributions can be summarized with inclusion
probabilities and Bayes factors.</p>
</div>
<div class="section level2">
<h2 id="example-fit">Example fit<a class="anchor" aria-label="anchor" href="#example-fit"></a>
</h2>
<p>We use a subset of the Wenchuan dataset:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Bayesian-Graphical-Modelling-Lab.github.io/bgms/" class="external-link">bgms</a></span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">Wenchuan</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="../reference/bgm.html">bgm</a></span><span class="op">(</span><span class="va">data</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="convergence-diagnostics">Convergence diagnostics<a class="anchor" aria-label="anchor" href="#convergence-diagnostics"></a>
</h2>
<p>The quality of the Markov chain can be assessed with common MCMC
diagnostics:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">$</span><span class="va">pairwise</span></span>
<span><span class="co">#&gt;                          mean          sd        mcse     n_eff</span></span>
<span><span class="co">#&gt; intrusion-dreams  0.629338089 0.001804519 0.067102463 1382.7822</span></span>
<span><span class="co">#&gt; intrusion-flash   0.338657791 0.001589875 0.060421205 1444.2846</span></span>
<span><span class="co">#&gt; intrusion-upset   0.202376428 0.064014992 0.004668924  187.9879</span></span>
<span><span class="co">#&gt; intrusion-physior 0.188939686 0.071198984 0.006082051  137.0400</span></span>
<span><span class="co">#&gt; dreams-flash      0.499816233 0.001803795 0.060493065 1124.7000</span></span>
<span><span class="co">#&gt; dreams-upset      0.225595383 0.053378801 0.001589095 1128.3344</span></span>
<span><span class="co">#&gt; dreams-physior    0.007497679 0.025566651 0.001247486  420.0263</span></span>
<span><span class="co">#&gt; flash-upset       0.004566734 0.019291950 0.001055790  333.8854</span></span>
<span><span class="co">#&gt; flash-physior     0.308420955 0.001426490 0.053789058 1421.8396</span></span>
<span><span class="co">#&gt; upset-physior     0.707339037 0.001706434 0.059781270 1227.3022</span></span>
<span><span class="co">#&gt;                        Rhat</span></span>
<span><span class="co">#&gt; intrusion-dreams  1.0047113</span></span>
<span><span class="co">#&gt; intrusion-flash   1.0024625</span></span>
<span><span class="co">#&gt; intrusion-upset   1.0026218</span></span>
<span><span class="co">#&gt; intrusion-physior 1.0002991</span></span>
<span><span class="co">#&gt; dreams-flash      1.0018317</span></span>
<span><span class="co">#&gt; dreams-upset      0.9999766</span></span>
<span><span class="co">#&gt; dreams-physior    1.0020293</span></span>
<span><span class="co">#&gt; flash-upset       0.9999943</span></span>
<span><span class="co">#&gt; flash-physior     0.9998950</span></span>
<span><span class="co">#&gt; upset-physior     1.0047092</span></span></code></pre></div>
<ul>
<li>R-hat values close to 1 (typically below 1.01) suggest convergence
<span class="citation">(<a href="#ref-VehtariEtAl_2021">Vehtari et al.,
2021</a>)</span>.</li>
<li>The effective sample size (ESS) reflects the number of independent
samples that would provide equivalent precision. Larger ESS values
indicate more reliable estimates.</li>
<li>The Monte Carlo standard error (MCSE) measures the additional
variability introduced by using a finite number of MCMC draws. A small
MCSE relative to the posterior standard deviation indicates stable
estimates, whereas a large MCSE suggests that more samples are
needed.</li>
</ul>
<p>Advanced users can inspect traceplots by extracting raw samples and
using external packages such as <code>coda</code> or
<code>bayesplot</code>. Here is an example using the <code>coda</code>
package to create a traceplot for a pairwise effect parameter.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span></span>
<span><span class="va">param_index</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="va">chains</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">raw_samples</span><span class="op">$</span><span class="va">pairwise</span>, <span class="kw">function</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="va">mat</span><span class="op">[</span>, <span class="va">param_index</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">mcmc_obj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">chains</span>, <span class="va">mcmc</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/traceplot.html" class="external-link">traceplot</a></span><span class="op">(</span><span class="va">mcmc_obj</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"firebrick"</span>, <span class="st">"steelblue"</span>, <span class="st">"darkgreen"</span>, <span class="st">"goldenrod"</span><span class="op">)</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Traceplot of pairwise[1]"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="diagnostics_files/figure-html/unnamed-chunk-5-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level2">
<h2 id="spike-and-slab-summaries">Spike-and-slab summaries<a class="anchor" aria-label="anchor" href="#spike-and-slab-summaries"></a>
</h2>
<p>The spike-and-slab prior yields posterior inclusion probabilities for
edges:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">$</span><span class="va">indicator</span></span>
<span><span class="co">#&gt;           intrusion dreams  flash  upset physior</span></span>
<span><span class="co">#&gt; intrusion    0.0000 1.0000 1.0000 0.9790  0.9405</span></span>
<span><span class="co">#&gt; dreams       1.0000 0.0000 1.0000 0.9985  0.0820</span></span>
<span><span class="co">#&gt; flash        1.0000 1.0000 0.0000 0.0545  1.0000</span></span>
<span><span class="co">#&gt; upset        0.9790 0.9985 0.0545 0.0000  1.0000</span></span>
<span><span class="co">#&gt; physior      0.9405 0.0820 1.0000 1.0000  0.0000</span></span></code></pre></div>
<ul>
<li>Values near 1.0: strong evidence the edge is present.</li>
<li>Values near 0.0: strong evidence the edge is absent.</li>
<li>Values near 0.5: inconclusive (absence of evidence).</li>
</ul>
</div>
<div class="section level2">
<h2 id="bayes-factors">Bayes factors<a class="anchor" aria-label="anchor" href="#bayes-factors"></a>
</h2>
<p>When the prior inclusion probability for an edge is equal to 0.5
(e.g., using a Bernoulli prior with
<code>inclusion_probability = 0.5</code> or a symmetric Beta prior,
<code>main_alpha = main_beta</code>), we can directly transform
inclusion probabilities into Bayes factors for edge presence vs
absence:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example for one edge</span></span>
<span><span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">$</span><span class="va">indicator</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">BF_10</span> <span class="op">=</span> <span class="va">p</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p</span><span class="op">)</span></span>
<span><span class="va">BF_10</span></span>
<span><span class="co">#&gt; [1] 15.80672</span></span></code></pre></div>
<p>Here the Bayes factor in favor of inclusion (H1) is small, meaning
that there is little evidence for inclusion. Since the Bayes factor is
transitive, we can use it to express the evidence in favor of exclusion
(H0) as</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span> <span class="op">/</span> <span class="va">BF_10</span></span>
<span><span class="co">#&gt; [1] 0.06326422</span></span></code></pre></div>
<p>This Bayes factor shows that there is strong evidence for the absence
of a network relation between the variables <code>intrusion</code> and
<code>physior</code>.</p>
</div>
<div class="section level2">
<h2 id="nuts-diagnostics">NUTS diagnostics<a class="anchor" aria-label="anchor" href="#nuts-diagnostics"></a>
</h2>
<p>When using <code>update_method = "nuts"</code> (the default),
additional diagnostics are available to assess the quality of the
Hamiltonian Monte Carlo sampling. These can be accessed via
<code>fit$nuts_diag</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">$</span><span class="va">nuts_diag</span><span class="op">$</span><span class="va">summary</span></span>
<span><span class="co">#&gt; $total_divergences</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $max_tree_depth_hits</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $min_ebfmi</span></span>
<span><span class="co">#&gt; [1] 0.9600455</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $warmup_incomplete</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<div class="section level3">
<h3 id="e-bfmi">E-BFMI<a class="anchor" aria-label="anchor" href="#e-bfmi"></a>
</h3>
<p>E-BFMI (Energy Bayesian Fraction of Missing Information) measures how
efficiently the sampler explores the posterior. It compares the typical
size of energy changes between successive samples to the overall spread
of energies. Values close to 1 indicate that the sampler moves freely
across the energy landscape; values below 0.3 suggest the sampler may be
getting stuck or that the chain has not yet settled into its stationary
distribution.</p>
<p>A low E-BFMI does not necessarily mean your results are wrong, but it
does warrant further investigation. In models with edge selection, the
most common cause is that the warmup period was too short for the
discrete graph structure to equilibrate. Increasing <code>warmup</code>
often resolves this.</p>
</div>
<div class="section level3">
<h3 id="divergent-transitions">Divergent transitions<a class="anchor" aria-label="anchor" href="#divergent-transitions"></a>
</h3>
<p>Divergent transitions occur when the numerical integrator encounters
regions of the posterior where the curvature changes too rapidly for the
current step size. A small number of divergences (say, fewer than 0.1%
of samples) is generally acceptable. However, many divergences indicate
that the sampler may be missing important parts of the posterior.</p>
<p>If you see a large number of divergences, consider increasing
<code>target_accept</code> (which makes the sampler use a smaller step
size) and, if this does not fix it, switching to
<code>update_method = "adaptive-metropolis"</code>.</p>
</div>
<div class="section level3">
<h3 id="tree-depth">Tree depth<a class="anchor" aria-label="anchor" href="#tree-depth"></a>
</h3>
<p>NUTS builds trajectories by repeatedly doubling their length until a
“U-turn” criterion is satisfied. If the trajectory frequently reaches
the maximum allowed depth (<code>nuts_max_depth</code>, default 10), it
suggests the sampler may benefit from longer trajectories to explore the
posterior efficiently. Hitting the maximum depth occasionally is normal;
hitting it on most iterations may indicate challenging posterior
geometry. If this happens, consider increasing
<code>nuts_max_depth</code>.</p>
</div>
<div class="section level3">
<h3 id="warmup-and-equilibration">Warmup and equilibration<a class="anchor" aria-label="anchor" href="#warmup-and-equilibration"></a>
</h3>
<p>Standard HMC/NUTS warmup is designed to tune the step size and mass
matrix for the continuous parameters. In models with edge selection, the
discrete graph structure may take longer to reach its stationary
distribution than the continuous parameters. As a result, even after
warmup completes, the first portion of the sampling phase may still show
transient behavior (i.e., non-stationarity).</p>
<p>The <code>warmup_check</code> component provides simple diagnostics
that compare the first and second halves of the post-warmup samples:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">$</span><span class="va">nuts_diag</span><span class="op">$</span><span class="va">warmup_check</span></span>
<span><span class="co">#&gt; $warmup_incomplete</span></span>
<span><span class="co">#&gt; [1] FALSE FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $energy_slope</span></span>
<span><span class="co">#&gt;     time_idx     time_idx </span></span>
<span><span class="co">#&gt; -0.001538370  0.001249026 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $slope_significant</span></span>
<span><span class="co">#&gt; time_idx time_idx </span></span>
<span><span class="co">#&gt;    FALSE    FALSE </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ebfmi_first_half</span></span>
<span><span class="co">#&gt; [1] 1.007220 1.085859</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ebfmi_second_half</span></span>
<span><span class="co">#&gt; [1] 0.9180415 0.9804561</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $var_ratio</span></span>
<span><span class="co">#&gt; [1] 1.0982277 0.8839425</span></span></code></pre></div>
<p>The returned list contains the following fields (one value per
chain):</p>
<ul>
<li>
<strong>warmup_incomplete</strong>: A logical flag that is
<code>TRUE</code> when any of the indicators below suggest the chain may
not have reached stationarity.</li>
<li>
<strong>energy_slope</strong>: The slope of a linear regression of
energy against iteration number. A slope near zero indicates stable
energy; a significant negative slope suggests the chain is still
drifting toward higher-probability regions.</li>
<li>
<strong>slope_significant</strong>: <code>TRUE</code> if the energy
slope is statistically significant (p &lt; 0.01).</li>
<li>
<strong>ebfmi_first_half</strong> and
<strong>ebfmi_second_half</strong>: E-BFMI computed separately for the
first and second halves of the post-warmup samples. If the first-half
value is much lower (for example, below 0.3) while the second-half value
is healthy, the early samples were likely still settling.</li>
<li>
<strong>var_ratio</strong>: The ratio of energy variance in the
first half to that in the second half. A ratio much greater than 1 (for
example, above 2) indicates higher variability early on, consistent with
transient behavior.</li>
</ul>
<p>If these diagnostics suggest the chain was still settling, increase
<code>warmup</code> and re-run the model. If diagnostics remain
problematic after a substantial increase (for example, doubling or
tripling <code>warmup</code>), consider re-fitting with
<code>update_method = "adaptive-metropolis"</code> and comparing the
posterior summaries. If the two samplers produce similar results, the
estimates are likely trustworthy despite the warnings; if they differ
substantially, that warrants further investigation of the model or
data.</p>
</div>
</div>
<div class="section level2">
<h2 id="next-steps">Next steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<ul>
<li>See <em>Getting Started</em> for a simple one-sample workflow.</li>
<li>See <em>Model Comparison</em> for group differences.</li>
</ul>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0" line-spacing="2">
<div id="ref-VehtariEtAl_2021" class="csl-entry">
Vehtari, A., Gelman, A., Simpson, D., Carpenter, B., &amp; Bürkner,
P.-C. (2021). Rank-normalization, folding, and localization: An improved
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>R</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{R}</annotation></semantics></math>
for assessing convergence of MCMC. <em>Bayesian Analysis</em>,
<em>16</em>(2), 667–718. <a href="https://doi.org/10.1214/20-BA1221" class="external-link">https://doi.org/10.1214/20-BA1221</a>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by Maarten Marsman, Don van den Bergh.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

  </div></footer>
</body>
</html>
